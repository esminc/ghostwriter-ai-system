# GhostWriter システム仕様書 v1.0

## 📌 目的と概要

### 🎯 プロダクト目的

GhostWriterは以下の研究目的で開発されている実験的AIアプリケーションです：

1. **AIの機能を活用したアプリの研究**
   - LLM（Large Language Model）の実用的活用方法の探求
   - AI生成コンテンツの品質向上手法の研究
   - プロンプトエンジニアリングのベストプラクティス収集

2. **MCPを使ったアーキテクチャの知見収集**
   - Model Context Protocol（MCP）の実装パターン研究
   - 従来API vs MCP統合の比較分析
   - マイクロサービスアーキテクチャにおけるMCPの位置づけ

3. **開発サポートにAIを使った場合の研究**
   - AI支援開発プロセスの効果測定
   - コード生成・レビュー・テストにおけるAI活用
   - 開発速度と品質のバランス分析

### 🎭 システムの性質と位置づけ

**重要**: GhostWriterは**ジョークプログラム**として設計されており、本格的な実用性を追求したものではありません。

#### システムの本質
- **AI研究プロダクトのネタ** として開発
- 現在運用中の日記システムに「たまたま乗った」実験的機能
- **参加メンバーの関心を集め、研究活動を盛り上げる**ことが主目的
- 正確性よりも**研究への参加促進**を優先

#### 情報の真実性に関する方針
日記・日報のような情報記録活動において、AIで生成された「真ではない可能性のある情報」をそのまま掲載することの問題を認識しつつ、以下の方針で運用：

1. **研究目的の優先**
   - 将来的なAI精度向上までの過渡期として位置づけ
   - ジョークプログラムとしての性質を活かした運用

2. **失敗の透明性**
   - 生成失敗時は「それらしい情報」でのフォールバックを避ける
   - **明確に「失敗しました」とレスポンス**し、研究データとして活用
   - 失敗パターンの分析により知見収集を促進

3. **内容の創造性許容**
   - 参照情報を元にしつつ、**多少の誇張や捏造を許容**
   - 正確性よりも**エンゲージメント向上**を重視
   - メンバーの関心を引く創造的な表現を推奨

**注意**: この方針は現在のAI技術水準と研究目的に基づくものであり、将来的な精度向上や運用環境の変化により見直される可能性があります。

このドキュメントは、上記研究目的を達成しながら、GhostWriter AI代筆日記システムの**不変的な仕様**と**守るべき動作**を定義します。
バグ修正や機能追加時に、既存の正常動作を破損しないための参照資料として使用します。

**重要**: すべての変更は研究価値とシステム安定性の両方を考慮して実施してください。

---

## 🔒 **CRITICAL: 絶対に守るべき仕様**

### 1. 核心機能要件（変更禁止）

#### 1.1 日記生成の基本動作
- **入力**: Slackユーザー名 → **出力**: 個人化された日記コンテンツ
- **必須メソッド**: `generateDiaryWithMCP(userName, options)` が正常動作する
- **必須戻り値構造**:
```javascript
{
  success: boolean,
  diary: {
    title: string,        // 必須: **WIP** 【代筆】{displayName}: {summary}
    content: string,      // 必須: 構造化本文 + 品質フッター
    category: string,     // 必須: '/AI代筆日記/'
    qualityScore: number  // 必須: 1-5
  },
  metadata: object       // システム情報
}
```

#### 1.2 エラーハンドリング（必須実装）
- **必須メソッド**: `generatePersonalizedDiaryContent(userName, contextData, today)` の存在
- **失敗時の透明性**: エラー時は「それらしい情報」でのフォールバックを避ける
- **研究データとしての価値**: 失敗情報を明確に表示し、分析対象とする
- **重大エラー時**: システムクラッシュは避け、「研究実験中のエラー」として報告

#### 1.3 MCP統合（変更禁止）
- **初期化**: `initialize()` メソッドで MCP接続確立
- **esa接続**: `mcpManager.getConnection('esa')` が利用可能
- **投稿機能**: `postToEsaWithMCP(diaryData, metadata)` が動作

### 2. 日記内容の品質要件（厳守事項）

#### 2.1 開発システム情報の除外（重要）
- **禁止用語**: 日記本文に以下を含めない
  - Phase, MCP, API, システム統合, 完成版, 修正版
  - 開発関連のカテゴリ名や技術用語
- **対象範囲**: 日記本文（フッター前の `---` より前）
- **例外条件**: 
  - esa/Slackから取得した実際のデータに含まれる場合は使用可能
  - 情報源が実際の活動記録であれば禁止用語でも掲載OK
  - 単語をピンポイントで禁止する必要はなし（自然性重視）
- **基本方針**: AI生成で不自然に技術用語を追加しない
- **実装場所**: `generatePersonalizedDiaryContent` メソッド

#### 2.2 個人活動への完全フォーカス
- **内容**: ユーザーの実際の活動・体験のみ記載
- **必須構造**: 3セクション形式で構成
  - `## やったこと` - 具体的な活動・作業内容
  - `## TIL (Today I Learned)` - 学んだこと・新しい発見・気づき
  - `## こんな気分` - 感想・反省・精神的な状態
- **語調**: 自然で個人的な表現
- **実装場所**: `generatePersonalizedDiaryContent` メソッド

#### 2.3 品質フッターの必須要素
- **必須セクション**:
  - 🤖 AI統合システム情報
  - 📊 個人化品質
  - 💾 データソース情報
- **必須実装**: `generateCleanQualityFooter` メソッド
- **除外対象**: 開発システム情報、技術詳細

### 3. esa投稿の仕様（変更禁止）

#### 3.1 投稿者属性
- **投稿者**: `esa_bot` (user属性で指定)
- **実装**: `postToEsaWithMCP` で `user: 'esa_bot'` 指定

#### 3.2 投稿形式
- **タイトル**: `**WIP** 【代筆】{displayName}: {content_summary}` 形式
  - 代筆であることを明確に表示（【代筆】必須）
  - 対象ユーザー名を明記（可能なら日本語表記優先）
  - 内容の概要を簡潔に表現
- **本文構造**: 以下の3セクション必須
  - `## やったこと` - 具体的な活動内容
  - `## TIL (Today I Learned)` - 学びや気づき
  - `## こんな気分` - 感想や反省
  - 品質フッター（`---` 以下）
- **カテゴリ**: `/AI代筆日記/` 固定
  - 通常の日記との区別を明確化
  - AI生成コンテンツであることを示す
- **状態**: WIP（下書き）として投稿（現状維持）

---

## 🛡️ **保護すべき動作パターン**

### 1. 正常な実行フロー（破損厳禁）

```
1. SlackBot起動 → app.js → generateDiary()
2. MCP統合システム初期化
3. ユーザーマッピング（Migration Manager）
4. Phase 5.3 Unified Generator 呼び出し
5. プロフィール分析 → 日記生成 → esa投稿
6. 成功レスポンス返却
```

### 2. エラー時の安全動作（必須）

```
エラー発生 → 失敗状況の透明な報告 → 研究データとして記録
※ フォールバック日記生成は行わず、実際の失敗を報告
※ システムクラッシュは絶対に発生させない
```

### 3. 品質保証プロセス（維持必須）

- プロフィール分析の実行
- 個人化スコアの算出
- **3セクション構造の強制**（やったこと、TIL、こんな気分）
- **【代筆】タグとユーザー名の明記**
- 品質フッターの生成
- 透明性の確保

---

## 📊 **品質指標（KPI）**

### 必須達成指標
- **システムクラッシュ率**: 0% （完全クラッシュフリー）
- **失敗透明性**: 100% （失敗時は明確に失敗を報告）
- **個人化品質**: 4.0/5 以上 （参照情報に基づく）
- **エンゲージメント**: 高 （メンバーの関心を引く）

### 内容品質指標
- **参照情報反映率**: 70% 以上 （完全な精度は要求しない）
- **創造性許容率**: 30% 以下 （適度な誇張・捏造を許容）
- **文字数**: 300-800文字
- **構造完整性**: 必須セクション含有率 100%
- **ジョーク要素**: 適度に含有 （研究活動を盛り上げる）

### 研究価値指標
- **MCP統合程度**: 80% 以上 （従来APIからの移行率）
- **AI活用範囲**: 90% 以上 （コード生成・テスト・レビュー）
- **知見収集品質**: 高 （技術ドキュメント化、ベストプラクティス文書化）
- **実験性と安定性**: バランス良好 （新技術導入と品質維持）

---

## 🔧 **システム設定（変更時要注意）**

### 1. 環境変数（必須設定）
```bash
# esa API設定
ESA_ACCESS_TOKEN=[.env ファイルで設定]
ESA_TEAM_NAME=esminc-its

# Slack Bot設定
SLACK_BOT_TOKEN=[.env ファイルで設定]
SLACK_SIGNING_SECRET=[.env ファイルで設定]
```

**重要**: 実際のトークンは `.env` ファイルで管理し、Gitリポジトリには含めないこと。

### 2. 重要なファイル構造（移動禁止）
```
src/
├── mcp-integration/
│   └── llm-diary-generator-phase53-unified.js  # 核心エンジン
├── slack/
│   └── app.js                                  # Slackボットメイン
└── services/
    └── migration-manager.js                    # ユーザーマッピング
```

---

## 🚨 **変更時の必須チェックリスト**

### バグ修正時
- [ ] `generatePersonalizedDiaryContent` メソッドの存在確認
- [ ] 日記本文に開発用語が混入していないか
- [ ] 3セクション構造（やったこと、TIL、こんな気分）が維持されているか
- [ ] タイトルに【代筆】タグとユーザー名が含まれているか
- [ ] カテゴリが '/AI代筆日記/' に設定されているか
- [ ] 品質フッターが正常に生成されるか
- [ ] エラー時に「それらしいフォールバック」で誘導していないか
- [ ] 失敗情報が明確に表示されるか
- [ ] MCP投稿の user 属性が 'esa_bot' になっているか

### 機能追加時
- [ ] 既存の日記生成フローに影響しないか
- [ ] 必須戻り値構造が維持されているか
- [ ] 品質指標（KPI）が低下していないか
- [ ] エラーハンドリングが適切に動作するか

### 研究価値確認時
- [ ] AI活用の学びがあるか（プロンプト、品質向上等）
- [ ] MCPアーキテクチャの知見が得られるか
- [ ] AI支援開発の効果が測定できるか
- [ ] 技術的チャレンジと安定性のバランスが取れているか

### ジョークプログラムとしての確認時
- [ ] 失敗時に「それらしい情報」で誘導していないか
- [ ] メンバーの関心を引く内容になっているか
- [ ] 適度な創造性（誇張・捏造）が含まれているか
- [ ] 研究活動への参加促進に貢献しているか

### テスト必須項目
- [ ] `npm run slack:dev` でエラーなく起動
- [ ] `/ghostwrite` コマンドで日記生成成功または失敗明示
- [ ] 生成された日記に開発情報が含まれていない
- [ ] タイトルが `**WIP** 【代筆】{displayName}: {summary}` 形式になっている
- [ ] 3セクション構造（やったこと、TIL、こんな気分）が含まれている
- [ ] カテゴリが '/AI代筆日記/' に設定されている
- [ ] エラー時にフォールバックではなく失敗情報が表示される
- [ ] esa投稿が正常に完了または失敗明示
- [ ] 品質フッターに必要な情報が含まれている

---

## 📝 **参考情報**

### 重要なクラス・メソッド
- `LLMDiaryGeneratorPhase53Unified` - 核心エンジン
- `generateDiaryWithMCP()` - メイン生成メソッド
- `generatePersonalizedDiaryContent()` - 個人化コンテンツ生成
- `generateCleanQualityFooter()` - 品質フッター生成
- `postToEsaWithMCP()` - esa投稿処理
- **非推奨**: `generatePhase53EmergencyFallback()` - フォールバック日記生成（使用非推奨）

### 最新の修正履歴
- **2025-06-05**: 開発チャット情報混入問題完全解決
- **2025-06-05**: 品質フッター復活
- **2025-06-05**: TypeError: generatePersonalizedDiaryContent 解決
- **2025-06-05**: ジョークプログラムとしての位置づけ明確化
- **2025-06-05**: 失敗透明性と創造性許容の方針追加
- **2025-06-05**: エラーハンドリングの矛盾解決（フォールバック廃止）
- **2025-06-05**: 投稿形式の詳細化（【代筆】タグ、3セクション構造、カテゴリ統一）

---

## ⚠️ **重要な注意事項**

1. **この仕様書は「不変の約束」です**
   - バグ修正時も、機能追加時も、必ずこの仕様を守る
   - 仕様変更が必要な場合は、事前にこのドキュメントを更新

2. **テストの義務**
   - 任意の変更後は、必ずチェックリストを実行
   - 1つでも失敗があれば、変更を取り消す

3. **品質の維持**
   - ユーザー体験を最優先とする
   - 技術的詳細はフッターのみに留める
   - 自然で読みやすい日記生成を心がける

4. **研究価値の維持**
   - すべての変更でAI活用の学びを追求する
   - MCPアーキテクチャの知見を積極的に収集する
   - 技術的チャレンジと安定性のバランスを維持する
   - 実験結果と知見を適切に文書化する

---

**この仕様書は GhostWriter システムの「憲法」です。**
**すべての変更は、この仕様を守ることを前提として行ってください。**

---

*最終更新: 2025-06-05*  
*バージョン: v1.1*  
*承認者: 開発チーム*
*更新内容: 研究目的、ジョークプログラムとしての位置づけ、失敗透明性方針の明確化*